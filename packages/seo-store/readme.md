# `@yoast/seo-store`

This package aims to provide a single Redux store for all Yoast features. It contains analysis paper data, Yoast form data, and in the future will contain all Yoast options and features.

> This package is agnostic, meaning it should be able to work for all platforms. When adding code, be sure it is not specific to a single platform, for instace WordPress.

## Installation & building

To install this package run the following command in your terminal:

```sh
yarn add @yoast/seo-store
# For local development
yarn link @yoast/seo-store
```

This package is built with Babel. To build this package run the following command in your terminal:

```sh
yarn build
# For local development
yarn watch
```

This package is published on the NPM registry. To publish a new version ...

> Publish strategy not decided upon.

## Redux best practices, Redux Toolkit & the duck structure

It's worth mentioning that even though this package was built with `@wordpress/data`, it follows standard Redux best practices like no derived data in state, event-like actions ("this happended" over "set something in state"), flexible reducers and status constants over status booleans. We use Redux Toolkit to adhere to these standards and for its great tooling in working with Redux. Read more on Redux best practices and tooling in [the Redux styleguide](https://redux.js.org/style-guide/style-guide) and [the Redux Toolkit docs](https://redux-toolkit.js.org.

The file and state structure is organised in a duck pattern, meaning the files and state object are split based on features rather than types. Read more about this pattern in [the Redux docs](https://redux.js.org/faq/code-structure). In example:

```sh
# Not duck file structure.
- src
-- redux
--- reducers
--- actions
--- selectors
-- helpers
-- components

# Duck file structure.
- src
-- feature-1
--- slice # Containing reducers, actions and selectors for this feature. Read more about slices below.
--- helpers
--- components
-- feature-2
--- slice
--- components
```

### Slices

The state is split up in to "slices". A slice represents a part of the state and contains relevant reducers, actions and selectors for that part of state. A slice can have sub-slices. Read more about slices in [the Redux Toolkit docs](https://redux-toolkit.js.org/api/createSlice). The current state structure looks like this, illustrating the use of slices in the comments:

```js
const state = {
    analysis: { // Analysis slice.
        config: { // Analysis config sub-slice.
            analysisType: "string", // Which analysis type is active.
            isSeoActive: true, // Is readability analysis enabled?
            isReadabilityActive: true, // Is readability analysis enabled?
        },
        results: { // Analysis results sub-slice.
            status: "idle", // Status of the analyze request, either "idle", "loading", "success" or "error".
            error: "Error message", // Error message for when status prop is "error".
            seo: {
                focus: {
                    score: 0,
                    results: [], // SEO analysis results as returned by analysis worker.
                },
                [ relatedKeyphraseId ]: {
                    score: 0,
                    results: [],
                },
                ...otherKeyphrases,
            },
            readability: {
                score: 0,
                results: [], // Readability analysis results as returned by analysis worker.
            },
            research: {
                morphology: [], // Morphology research results as returned by analysis worker.
            },
        },
    },
    editor: { // Editor slice with data relevant to the analysis.
        title: "string",
        content: "string",
        excerpt: "string",
        permalink: "string",
        date: "string",
        featuresImage: {
            id: "string",
            url: "string",
            alt: "string",
            width: 0,
            height: 0,
        },
    },
    form: { // Yoast form slice.
        keyphrases: { // Feature sub-slice for keyphrases.
            focus: {
                id: "focus",
                keyphrase: "string",
                synonyms: "string",
            },
            [ relatedKeyphraseId ]: {
                id: "auto-generated-related-keyphrase-id", // This id is auto-generated by nanoid.
                keyphrase: "string",
                synonyms: "string",
            },
        },
        seo: { // SEO form sub-slice, used by the snippet editor.
            title: "string", // SEO title.
            description: "string", // Meta description.
            slug: "string",
            isCornerstone: true,
        },
    },
}
```

### Reducers, actions & selectors

Each slice exports its own reducer, actions and selectors. For specific actions and selectors, please reference the slice itself in the source code. A selector always starts with `select` and can be optimized using the `createSelector` API from Redux toolkit.

## Using `registerSeoStore`
The package is built around a single `registerSeoStore` function that creates a Redux store and registers it with the default WordPress data registry.

### Arguments
`registerSeoStore` accepts a single `configuration` object argument with the following props:

**`initialState`** `Object`\
Initial state object. See typed state object above.

**`analyze`** `Function`\
Function able to analyzes paper data.

The function accepts three arguments: paper, keyphrases and config.

### Example usage

```js
const analyze = async ( paper, keyphrases, config ) => {
    // Process with in example the analysis worker
    const results = await fetchAnalysisResults( paper, keyphrases );
    return {
        seo: { ...results.seo },
        redability: { ...results.readabilty }, 
        ...etc
    }
};

// Aaand that's it!
registerSeoStore( {
    analyze,
    initialState,
} )
```

## Other exports

**`SEO_STORE_NAME`** `String`\
Name of the SEO Redux store. Use it along with `dispatch` and `select` from `@wordpress/data` to get access to the available `actions` and `selectors` in the store.

```js
const actions = dispatch( SEO_STORE_NAME );
const selectors = select( SEO_STORE_NAME );
```

**`FOCUS_KEYPHRASE_ID`** `String`\
Identifier of the focus keyphrase. Use it when referencing the focus keyphrase, instead of using the string "focus" directly.

**`useAnalysis`** `Function`\
React hook to enable the analysis. When this hook is in a renderd component, Redux will trigger new analyses when store data changes and add new analysis results to the store.

```js
const Component = ( { children } ) => {
    useAnalysis();
    return children;
};
```

## Extensibility

This package provide some `@wordpress/hooks` filters for extending its functionality:

**`yoast.seoStore.analysis.preparePaper`** `Filter`\
Filters the analysis paper data before it is send to the `analyze` function. Functions registered here accept the unfiltered paper data and must return valid paper data.

**This filter is the primary API for extending paper data to be analyzed.**

```js
addFilter(
    "yoast.seoStore.analysis.preparePaper",
    "addPaperData",
    ( paper ) => ( {
        ...paper,
        changeData: `${ paper.content } - add something to the paper content`,
        newData: "string",
    } ),
    10,
);
```

**`yoast.seoStore.analysis.processResults`** `Filter`\
Filters the analysis results before it is send dispatched to the store. Functions registered here accept the unfiltered results and must return valid analysis results.